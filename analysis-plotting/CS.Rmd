---
title: "Covariate shift analysis"
author: 
    - Jos√© Guilherme de Almeida
output: 
  html_document:
    theme: lumen
    highlight: tango
    code_folding: hide
    df_print: paged
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 4
    number_sections: true
--- 

# Setup

## Functions and setting up training data

```{r}
source("function-library.R")

library(tidyverse)
library(cowplot)
library(WRS2)
library(umap)
library(ggpubr)
library(caret)
library(glmnet)
library(pROC)
library(RRF)
library(MLmetrics)
library(RANN)

select <- dplyr::select
set.seed(4242)

make_folds <- function(f,k=5) {
  f_idx <- seq(1,length(f))
  output_folds <- lapply(1:k,function(x) list(train = c(),test = c()))
  f_unique <- unique(f)
  for (f_element in f_unique) {
    sub_f_idx <- f_idx[f == f_element]
    fold_assignment <- sample.int(k,length(sub_f_idx),replace = T)
    for (fold in sort(unique(fold_assignment))) {
      test_idx <- sub_f_idx[fold_assignment == fold]
      train_idx <- sub_f_idx[!(sub_f_idx %in% test_idx)]
      output_folds[[fold]]$train <- c(output_folds[[fold]]$train,train_idx)
      output_folds[[fold]]$test <- c(output_folds[[fold]]$test,test_idx)
    }
  }
  return(output_folds)
}

make_class_weights <- function(f) {
  weights_f <- 1 - table(f) / length(f)
  for (n in names(weights_f)) {
    f[f == n] <- weights_f[n]  
  }
  return(f)
}

make_class_weights_rf <- function(f) {
  weights_f <- 1 - table(f) / length(f)
  return(weights_f)
}

rearrange_data <- function(dataset,id="WBC") {
  means <- dataset %>%
    subset(f == "mean") %>%
    select(-f) %>%
    mutate(key = paste(key,"means",id,sep='.')) %>%
    spread(key = key,value = value)
  vars <- dataset %>%
    subset(f == "variance") %>%
    select(-f) %>%
    mutate(key = paste(key,"vars",id,sep='.')) %>%
    spread(key = key,value = value)
  output <- merge(means,vars,by = c(
    "slide_id","coarse_class","fine_class"))
  return(output)
}

all_conditions <- rbind(
  read_csv(
    "data/all_classes.csv",progress = F,
    col_types = c(col_character(),col_character(),col_character())) %>%
    select(slide_id = id,fine_class,coarse_class) %>% 
    mutate(fine_class = factor(fine_class_conversion[fine_class],fine_class_conversion),
           coarse_class = factor(class_conversion[coarse_class],class_conversion)),
  read_csv(
    "data/all_classes_adden_1.csv",progress = F,
    col_types = c(col_character(),col_character(),col_character())) %>%
    select(slide_id,fine_class,coarse_class) %>% 
    mutate(fine_class = factor(fine_class_conversion[fine_class],fine_class_conversion),
           coarse_class = factor(class_conversion[coarse_class],class_conversion)) %>%
    mutate(slide_id = gsub('\\.','',str_match(slide_id,'[0-9_-]+.'))),
  read_csv(
    "data/all_classes_adden_2.csv",progress = F,
    col_types = c(col_character(),col_character(),col_character())) %>%
    select(slide_id,fine_class,coarse_class) %>% 
    mutate(fine_class = factor(fine_class_conversion[fine_class],fine_class_conversion),
           coarse_class = factor(class_conversion[coarse_class],class_conversion))
)

rbc_counts <-  rbind(
  read_csv(
    "datasets/rbc_counts.csv",
    col_names = c("slide_id","counts"),
    col_types = c(col_character(),col_double())) %>%
    cbind(dataset = "MLLC"),
  read_csv(
    "datasets/rbc_adden_1_counts.csv",
    col_names = c("slide_id","counts"),
    col_types = c(col_character(),col_double()))  %>%
    cbind(dataset = "AC1"),
  read_csv(
    "datasets/rbc_adden_2_counts.csv",
    col_names = c("slide_id","counts"),
    col_types = c(col_character(),col_double())) %>%
    cbind(dataset = "AC2")
) %>%
  subset(!(slide_id %in% poor_quality_slides)) %>%
  group_by(slide_id,dataset) %>%
  summarise(n_rbc = sum(counts))

wbc_counts <-  rbind(
  read_csv(
    "datasets/wbc_counts.csv",
    col_names = c("slide_id","counts"),
    col_types = c(col_character(),col_double())) %>%
    cbind(dataset = "MLLC"),
  read_csv(
    "datasets/wbc_adden_1_counts.csv",
    col_names = c("slide_id","counts"),
    col_types = c(col_character(),col_double()))  %>%
    cbind(dataset = "AC1"),
  read_csv(
    "datasets/wbc_adden_2_counts.csv",
    col_names = c("slide_id","counts"),
    col_types = c(col_character(),col_double())) %>%
    cbind(dataset = "AC2")
) %>%
  subset(!(slide_id %in% poor_quality_slides)) %>%
  group_by(slide_id,dataset) %>%
  summarise(n_wbc = sum(counts))

# select slides with > 50 RBC and > 50 WBC
representative_slides <- merge(rbc_counts,wbc_counts,by = c("slide_id","dataset")) %>% 
  subset(n_rbc > 50 & n_wbc > 50) %>% 
  select(slide_id) %>%
  unlist

blood_parameters <- read_csv(
  "data/blood_count_data.csv",
  col_types = cols_only(
    id = col_character(),wbc_ul = col_double(),
    hb_g_dl = col_double(),plt_ul = col_double())) %>%
  select(slide_id = id,wbc_ul,hb_g_dl,plt_ul)

demographic_data <- read_csv(
  "data/demographic_data.csv",
  col_types = cols_only(
    id = col_character(),sex = col_character(),age = col_double())) %>%
  select(slide_id = id,sex,age)

wbc_all_cells_summaries <- read_csv(
  "datasets/wbc_summaries.csv",
  col_names = c("slide_id",features_all,features_nuclear,"f"),
  col_types = c(list(col_character()),
                replicate(length(c(features_all,features_nuclear)),col_double()),
                list(col_character()))) %>%
  merge(all_conditions,by = "slide_id") %>% 
  as_tibble() %>% 
  mutate(fine_class = ifelse(coarse_class == "MDS",
                             ifelse(grepl("SF3B1",fine_class),
                                    "SF3B1-mutant",
                                    "Non-SF3B1-mutant"),
                             as.character(fine_class))) %>%
  mutate(fine_class = factor(
    as.character(fine_class),
    levels = fine_simple_levels)) %>%
  subset(!(slide_id %in% poor_quality_slides)) %>% 
  subset(slide_id %in% representative_slides)

wbc_adden_1_cells_summaries <- read_csv(
  "datasets/wbc_adden_1_summaries.csv",
  col_names = c("slide_id",features_all,features_nuclear,"f"),
  col_types = c(list(col_character()),
                replicate(length(c(features_all,features_nuclear)),col_double()),
                list(col_character()))) %>%
  merge(all_conditions,by = "slide_id") %>% 
  as_tibble() %>% 
  mutate(fine_class = ifelse(coarse_class == "MDS",
                             ifelse(grepl("SF3B1",fine_class),
                                    "SF3B1-mutant",
                                    "Non-SF3B1-mutant"),
                             as.character(fine_class))) %>%
  mutate(fine_class = factor(
    as.character(fine_class),
    levels = fine_simple_levels)) %>%
  subset(!(slide_id %in% poor_quality_slides)) %>% 
  subset(slide_id %in% representative_slides)

rbc_all_cells_summaries <- read_csv(
  "datasets/rbc_summaries.csv",
  col_names = c("slide_id",features_all,"f"),
  col_types = c(list(col_character()),
                replicate(length(c(features_all)),col_double()),
                list(col_character()))) %>%
  merge(all_conditions,by = "slide_id") %>%
  as_tibble() %>% 
  mutate(fine_class = ifelse(coarse_class == "MDS",
                             ifelse(grepl("SF3B1",fine_class),
                                    "SF3B1-mutant",
                                    "Non-SF3B1-mutant"),
                             as.character(fine_class))) %>%
  mutate(fine_class = factor(
    as.character(fine_class),
    levels = fine_simple_levels)) %>%
  subset(!(slide_id %in% poor_quality_slides)) %>% 
  subset(slide_id %in% representative_slides)

rbc_adden_1_cells_summaries <- read_csv(
  "datasets/rbc_adden_1_summaries.csv",
  col_names = c("slide_id",features_all,"f"),
  col_types = c(list(col_character()),
                replicate(length(c(features_all)),col_double()),
                list(col_character()))) %>%
  merge(all_conditions,by = "slide_id") %>%
  as_tibble() %>% 
  mutate(fine_class = ifelse(coarse_class == "MDS",
                             ifelse(grepl("SF3B1",fine_class),
                                    "SF3B1-mutant",
                                    "Non-SF3B1-mutant"),
                             as.character(fine_class))) %>%
  mutate(fine_class = factor(
    as.character(fine_class),
    levels = fine_simple_levels)) %>%
  subset(!(slide_id %in% poor_quality_slides)) %>% 
  subset(slide_id %in% representative_slides)

IDs <- c("disease_detection","disease_classification","sf3b1","anaemia_classification")

K <- 5

label_conversion <- list(
  disease_detection = c(
    `Normal` = 0,
    `SF3B1-mutant` = 1,`Non-SF3B1-mutant` = 1,
    `Iron deficiency` = 1,`Megaloblastic` = 1),
  disease_classification = c(
    `Normal` = NA,
    `SF3B1-mutant` = 1,`Non-SF3B1-mutant` = 1,
    `Iron deficiency` = 0,`Megaloblastic` = 0),
  sf3b1 = c(
    `Normal` = NA,
    `SF3B1-mutant` = 1,`Non-SF3B1-mutant` = 0,
    `Iron deficiency` = NA,`Megaloblastic` = NA),
  anaemia_classification = c(
    `Normal` = NA,
    `SF3B1-mutant` = NA,`Non-SF3B1-mutant` = NA,
    `Iron deficiency` = 0,`Megaloblastic` = 1),
  multiclass_classification = c(
    `Normal` = 1,
    `SF3B1-mutant` = 2,`Non-SF3B1-mutant` = 3,
    `Iron deficiency` = 4,`Megaloblastic` = 5)
)

reverse_label_conversion <- list(
  disease_detection = c("Normal","Disease"),
  disease_classification = c("Anaemia","MDS"),
  sf3b1 = c("nonSF3B1","SF3B1"),
  anaemia_classification = c("Iron deficiency","Megaloblastic"),
  multiclass_classification = c("Normal","SF3B1","nonSF3B1","Iron deficiency","Megaloblastic")
)

glmnet_models <- list(
  morphology = list(),full = list(),bcdem = list())
glmnet_multiclass_models <- list(
  morphology = list(),full = list(),bcdem = list())
rf_models <- list(
  morphology = list(),full = list(),bcdem = list())
```

## Splitting data and defining folds

```{r}
wbc_feat_cols <- 1:ncol(wbc_all_cells_summaries)
rbc_feat_cols <- 1:ncol(rbc_all_cells_summaries)

wbc_all_cells_summaries <- wbc_all_cells_summaries[,wbc_feat_cols] %>%
  gather(key = "key",value = "value",-slide_id,-f,-fine_class,-coarse_class)
rbc_all_cells_summaries <- rbc_all_cells_summaries[,rbc_feat_cols] %>%
  gather(key = "key",value = "value",-slide_id,-f,-fine_class,-coarse_class)

wbc_adden_1_cells_summaries <- wbc_adden_1_cells_summaries[,wbc_feat_cols] %>%
  gather(key = "key",value = "value",-slide_id,-f,-fine_class,-coarse_class)
rbc_adden_1_cells_summaries <- rbc_adden_1_cells_summaries[,rbc_feat_cols] %>%
  gather(key = "key",value = "value",-slide_id,-f,-fine_class,-coarse_class)

wbc_dataset_morphology <- rearrange_data(
  wbc_all_cells_summaries,id = "WBC")
rbc_dataset_morphology <- rearrange_data(
  rbc_all_cells_summaries,id = "RBC")

wbc_dataset_morphology_adden_1 <- rearrange_data(
  wbc_adden_1_cells_summaries,id = "WBC")
rbc_dataset_morphology_adden_1 <- rearrange_data(
  rbc_adden_1_cells_summaries,id = "RBC")

full_dataset_morphology <- merge(
  wbc_dataset_morphology,
  rbc_dataset_morphology,
  by = c("slide_id","coarse_class","fine_class"))

full_dataset_morphology_adden_1 <- merge(
  wbc_dataset_morphology_adden_1,
  rbc_dataset_morphology_adden_1,
  by = c("slide_id","coarse_class","fine_class"))

full_dataset <- merge(
  full_dataset_morphology,blood_parameters,by = "slide_id") %>%
  merge(demographic_data,by = "slide_id") %>%
  mutate(sex = ifelse(sex == "male",0,1)) %>% 
  mutate(sex.BCDEM = sex,
         age.BCDEM = age,
         wbc_ul.BCDEM = wbc_ul,
         hb_g_dl.BCDEM = hb_g_dl,
         plt_ul.BCDEM = plt_ul) %>%
  select(-sex,-age,-wbc_ul,-hb_g_dl,-plt_ul)

full_dataset_collection <- list(
  data = list(
    morphology = select(full_dataset,-slide_id,-coarse_class,-fine_class,
                        -wbc_ul.BCDEM,-hb_g_dl.BCDEM,-plt_ul.BCDEM,
                        -sex.BCDEM,-age.BCDEM),
    full = select(full_dataset,-slide_id,-coarse_class,-fine_class,-sex.BCDEM,-age.BCDEM),
    bcdem = select(full_dataset,wbc_ul.BCDEM,hb_g_dl.BCDEM,plt_ul.BCDEM)
  ),
  coarse_labels = full_dataset$coarse_class,
  fine_labels = full_dataset$fine_class,
  slide_id = full_dataset$slide_id) 

stratified_folds <- make_folds(full_dataset_collection$fine_labels,k = K)

scales <- list(
  full = lapply(
    stratified_folds,
    function(x) {
      pp <- preProcess(full_dataset_collection$data$full[x$train,],
                       method = c("center","scale","corr","nzv","medianImpute"))
      return(pp)}),
  morphology = lapply(
    stratified_folds,
    function(x) {
      pp <- preProcess(full_dataset_collection$data$morphology[x$train,],
                       method = c("center","scale","corr","nzv","medianImpute"))
      return(pp)}),
  bcdem =   lapply(
    stratified_folds,
    function(x) {
      pp <- preProcess(full_dataset_collection$data$bcdem[x$train,],
                       method = c("center","scale","corr","nzv","medianImpute"))
      return(pp)})
)
```

## Data setup and processing for validation cohort

```{r}
wbc_cells_summaries_oos <- read_csv(
  "datasets/wbc_adden_2_summaries.csv",
  col_names = c("slide_id",features_all,features_nuclear,"f"),
  col_types = c(list(col_character()),
                replicate(length(c(features_all,features_nuclear)),col_double()),
                list(col_character()))) %>%
  merge(all_conditions,by = "slide_id") %>% 
  as_tibble() %>% 
  mutate(fine_class = ifelse(coarse_class == "MDS",
                             ifelse(grepl("SF3B1",fine_class),
                                    "SF3B1-mutant",
                                    "Non-SF3B1-mutant"),
                             as.character(fine_class))) %>%
  mutate(fine_class = factor(
    as.character(fine_class),
    levels = fine_simple_levels)) %>%
  subset(!(slide_id %in% poor_quality_slides)) %>%
  subset(slide_id %in% representative_slides)

rbc_cells_summaries_oos <- read_csv(
  "datasets/rbc_adden_2_summaries.csv",
  col_names = c("slide_id",features_all,"f"),
  col_types = c(list(col_character()),
                replicate(length(c(features_all)),col_double()),
                list(col_character()))) %>%
  merge(all_conditions,by = "slide_id") %>%
  as_tibble() %>% 
  mutate(fine_class = ifelse(coarse_class == "MDS",
                             ifelse(grepl("SF3B1",fine_class),
                                    "SF3B1-mutant",
                                    "Non-SF3B1-mutant"),
                             as.character(fine_class))) %>%
  mutate(fine_class = factor(
    as.character(fine_class),
    levels = fine_simple_levels)) %>%
  subset(!(slide_id %in% poor_quality_slides)) %>%
  subset(slide_id %in% representative_slides)

wbc_cells_summaries_oos <- wbc_cells_summaries_oos[,wbc_feat_cols] %>%
  gather(key = "key",value = "value",-slide_id,-f,-fine_class,-coarse_class)

rbc_cells_summaries_oos <- rbc_cells_summaries_oos[,rbc_feat_cols] %>%
  gather(key = "key",value = "value",-slide_id,-f,-fine_class,-coarse_class)

wbc_dataset_morphology_oos <- rearrange_data(
  wbc_cells_summaries_oos,"WBC")
rbc_dataset_morphology_oos <- rearrange_data(
  rbc_cells_summaries_oos,"RBC")

blood_count_data_oos <- read_csv(
  "data/blood_count_data_adden_2.csv",
  col_types = cols_only(
    id = col_character(),wbc_ul = col_double(),
    hb_g_dl = col_double(),plt_ul = col_double())) %>%
  select(slide_id = id,wbc_ul,hb_g_dl,plt_ul)

repeated_slides <- c(
  "SF3B1_5_B","SF3B1_9_2A","SF3B1_14B",
  "Megaloblastic_7")

full_dataset_oos <- merge(
  wbc_dataset_morphology_oos,
  rbc_dataset_morphology_oos,
  by = c("slide_id","coarse_class","fine_class")) %>%
  merge(blood_count_data_oos,by = "slide_id") %>% 
  mutate(wbc_ul.BCDEM = wbc_ul*1000,
         hb_g_dl.BCDEM = hb_g_dl/10,
         plt_ul.BCDEM = plt_ul*1000) %>%
  select(-wbc_ul,-hb_g_dl,-plt_ul) %>%
  na.omit() %>%
  subset(!(slide_id %in% repeated_slides))

full_dataset_collection_oos <- list(
  data = list(
    morphology = select(full_dataset_oos,-slide_id,-coarse_class,-fine_class,
                        -wbc_ul.BCDEM,-hb_g_dl.BCDEM,-plt_ul.BCDEM),
    full = select(full_dataset_oos,-slide_id,-coarse_class,-fine_class),
    bcdem = select(full_dataset_oos,wbc_ul.BCDEM,hb_g_dl.BCDEM,plt_ul.BCDEM)
  ),
  coarse_labels = full_dataset_oos$coarse_class,
  fine_labels = full_dataset_oos$fine_class,
  slide_id = full_dataset_oos$slide_id) 
```

# Feature visualization

Here I see how features are distributed between different conditions and, more importantly for this notebook, between different datasets.

```{r}
umap_cells <- function(RBC_data,WBC_data,m=0.5,Merge=T) {
  WBC_umap <- WBC_data[,unlist(summarise_all(WBC_data,is.numeric))] %>%
    scale %>%
    umap(min_dist = m)
  WBC_umap_df <- WBC_umap$layout %>%
    as.tibble() %>% 
    mutate(dataset = WBC_data$dataset,
           coarse_class = WBC_data$coarse_class,
           fine_class = WBC_data$fine_class)
  
  RBC_umap <- RBC_data[,unlist(summarise_all(RBC_data,is.numeric))] %>%
    scale %>%
    umap(min_dist = m)
  RBC_umap_df <- RBC_umap$layout %>%
    as.tibble() %>% 
    mutate(dataset = RBC_data$dataset,
           coarse_class = RBC_data$coarse_class,
           fine_class = RBC_data$fine_class)
  if (Merge == T) {
    WBC_RBC_data <- merge(RBC_data,WBC_data,by = c("slide_id","coarse_class","fine_class","dataset"))
    WBC_RBC_umap <- WBC_RBC_data[,unlist(summarise_all(WBC_RBC_data,is.numeric))] %>%
      scale %>% 
      umap(min_dist = m)
    WBC_RBC_umap_df <- WBC_RBC_umap$layout %>%
      as.tibble() %>% 
      mutate(dataset = WBC_RBC_data$dataset,
             coarse_class = WBC_RBC_data$coarse_class,
             fine_class = WBC_RBC_data$fine_class)
  } else {
    WBC_RBC_umap_df <- NULL
  }
  return(list(wbc = WBC_umap_df,rbc = RBC_umap_df,wbc_rbc = WBC_RBC_umap_df))
}

pca_cells <- function(RBC_data,WBC_data,Merge=T) {
  WBC_pca <- WBC_data[,unlist(summarise_all(WBC_data,is.numeric))] %>%
    scale %>%
    prcomp()
  WBC_pca_df <- WBC_pca$x %>%
    as.tibble() %>% 
    mutate(dataset = WBC_data$dataset,
           coarse_class = WBC_data$coarse_class,
           fine_class = WBC_data$fine_class)
  
  RBC_pca <- RBC_data[,unlist(summarise_all(RBC_data,is.numeric))] %>%
    scale %>%
    prcomp()
  RBC_pca_df <- RBC_pca$x %>%
    as.tibble() %>% 
    mutate(dataset = RBC_data$dataset,
           coarse_class = RBC_data$coarse_class,
           fine_class = RBC_data$fine_class)
  
  if (Merge == T) {
    WBC_RBC_data <- merge(RBC_data,WBC_data,by = c("slide_id","coarse_class","fine_class","dataset"))
    WBC_RBC_pca <- WBC_RBC_data[,unlist(summarise_all(WBC_RBC_data,is.numeric))] %>%
      scale %>% 
      prcomp()
    WBC_RBC_pca_df <- WBC_RBC_pca$x %>%
      as.tibble() %>% 
      mutate(dataset = WBC_RBC_data$dataset,
             coarse_class = WBC_RBC_data$coarse_class,
             fine_class = WBC_RBC_data$fine_class)
  } else {
    WBC_RBC_pca_df <- NULL
  }
  return(list(wbc = WBC_pca_df,rbc = RBC_pca_df,wbc_rbc = WBC_RBC_pca_df))
}

RBC_data_all <- rbind(
  read_csv("datasets/rbc_adden_1_summaries.csv",
           col_names = c("slide_id",features_all,"moment")) %>%
    mutate(dataset = "AC1"),
  read_csv("datasets/rbc_summaries.csv",
           col_names = c("slide_id",features_all,"moment")) %>%
    mutate(dataset = "MLL"),
  read_csv("datasets/rbc_adden_2_summaries.csv",
           col_names = c("slide_id",features_all,"moment")) %>%
    mutate(dataset = "AC2")) %>%
  merge(all_conditions,by = "slide_id")
WBC_data_all <- rbind(
  read_csv("datasets/wbc_adden_1_summaries.csv",
           col_names = c("slide_id",features_all,features_nuclear,"moment")) %>%
    mutate(dataset = "AC1"),
  read_csv("datasets/wbc_summaries.csv",
           col_names = c("slide_id",features_all,features_nuclear,"moment")) %>%
    mutate(dataset = "MLL"),
  read_csv("datasets/wbc_adden_2_summaries.csv",
           col_names = c("slide_id",features_all,features_nuclear,"moment")) %>%
    mutate(dataset = "AC2")) %>%
  merge(all_conditions,by = "slide_id") 

RBC_cells <- rbind(
  read_csv("datasets/rbc_adden_1_all_cells.csv",
           col_names = c("slide_id",features_all)) %>%
    mutate(dataset = "AC1"),
  read_csv("datasets/rbc_all_cells.csv",
           col_names = c("slide_id",features_all)) %>%
    mutate(dataset = "MLL"),
  read_csv("datasets/rbc_adden_2_all_cells.csv",
           col_names = c("slide_id",features_all)) %>%
    mutate(dataset = "AC2")) %>%
  merge(all_conditions,by = "slide_id")
WBC_cells <- rbind(
  read_csv("datasets/wbc_adden_1_all_cells.csv",
           col_names = c("slide_id",features_all,features_nuclear)) %>%
    mutate(dataset = "AC1"),
  read_csv("datasets/wbc_all_cells.csv",
           col_names = c("slide_id",features_all,features_nuclear)) %>%
    mutate(dataset = "MLL"),
  read_csv("datasets/wbc_adden_2_all_cells.csv",
           col_names = c("slide_id",features_all,features_nuclear)) %>%
    mutate(dataset = "AC2")) %>%
  merge(all_conditions,by = "slide_id")
```

## Visualizing individual feature distributions between datasets

### For red blood cells (RBC)

```{r,fig.height=4.5,fig.width=6}
plot_grid(
  RBC_data_all %>% 
    subset(moment == "mean") %>%
    gather("key","value",-slide_id,-moment,-dataset,-fine_class,-coarse_class) %>%
    group_by(key) %>% 
    mutate(standardized_value = scale(value)) %>% 
    ggplot(aes(x = key,y = standardized_value,colour = dataset)) + 
    stat_summary(geom = "point",fun.data = median_hilow,position = position_dodge(width=0.5),size = 0.5) + 
    stat_summary(geom = "linerange",fun.data = median_hilow,size = 0.25,position = position_dodge(width=0.5)) +
    theme_pretty(base_size = 6) + 
    xlab("Feature") + 
    ylab("Standardized value") + 
    coord_flip() + 
    theme(legend.position = "bottom") + 
    ggtitle("RBC mean distribution (min-(median)-max)"),
  RBC_data_all %>% 
    subset(moment == "variance") %>%
    gather("key","value",-slide_id,-moment,-dataset,-fine_class,-coarse_class) %>%
    group_by(key) %>% 
    mutate(standardized_value = scale(value)) %>% 
    ggplot(aes(x = key,y = standardized_value,colour = dataset)) + 
    stat_summary(geom = "point",fun.data = median_hilow,position = position_dodge(width=0.5),size = 0.5) + 
    stat_summary(geom = "linerange",fun.data = median_hilow,size = 0.25,position = position_dodge(width=0.5)) +
    theme_pretty(base_size = 6) + 
    xlab("Feature") + 
    ylab("Standardized value") + 
    coord_flip() + 
    theme(legend.position = "bottom") + 
    ggtitle("RBC variance distribution (min-(median)-max)"),
  ncol = 2
)
```

### For white blood cells (WBC)

```{r,fig.height=4.5,fig.width=6}
plot_grid(
  WBC_data_all %>% 
    subset(moment == "mean") %>%
    gather("key","value",-slide_id,-moment,-dataset,-fine_class,-coarse_class) %>%
    group_by(key) %>% 
    mutate(standardized_value = scale(value)) %>% 
    ggplot(aes(x = key,y = standardized_value,colour = dataset)) + 
    stat_summary(geom = "point",fun.data = median_hilow,position = position_dodge(width=0.5),size = 0.5) + 
    stat_summary(geom = "linerange",fun.data = median_hilow,size = 0.25,position = position_dodge(width=0.5)) +
    theme_pretty(base_size = 6) + 
    xlab("Feature") + 
    ylab("Standardized value") + 
    coord_flip() + 
    theme(legend.position = "bottom") + 
    ggtitle("WBC mean distribution (min-(median)-max)"),
  WBC_data_all %>% 
    subset(moment == "variance") %>%
    gather("key","value",-slide_id,-moment,-dataset,-fine_class,-coarse_class) %>%
    group_by(key) %>% 
    mutate(standardized_value = scale(value)) %>% 
    ggplot(aes(x = key,y = standardized_value,colour = dataset)) + 
    stat_summary(geom = "point",fun.data = median_hilow,position = position_dodge(width=0.5),size = 0.5) + 
    stat_summary(geom = "linerange",fun.data = median_hilow,size = 0.25,position = position_dodge(width=0.5)) +
    theme_pretty(base_size = 6) + 
    xlab("Feature") + 
    ylab("Standardized value") + 
    coord_flip() + 
    theme(legend.position = "bottom") + 
    ggtitle("WBC variance distribution (min-(median)-max)"),
  ncol = 2
)
```

## Visualizing multivariate distributions

### Principal component analysis

```{r}
RBC_data <- RBC_data_all %>% 
  subset(moment == "mean")
WBC_data <- WBC_data_all %>%
  subset(moment == "mean")
mean_pca_output <- pca_cells(RBC_data,WBC_data)

RBC_data <- RBC_data_all %>% 
  subset(moment == "variance")
WBC_data <- WBC_data_all %>%
  subset(moment == "variance")
variance_pca_output <- pca_cells(RBC_data,WBC_data)

plot_grid(
  ggplot(mean_pca_output$wbc,aes(x = PC1,y = PC2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("PC1") + 
    ylab("PC2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("PCA input: WBC mean"),
  ggplot(mean_pca_output$rbc,aes(x = PC1,y = PC2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("PC1") + 
    ylab("PC2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("PCA input: RBC mean"),
  ggplot(mean_pca_output$wbc_rbc,aes(x = PC1,y = PC2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("PC1") + 
    ylab("PC2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("PCA input: concatenated WBC and RBC means"),
  ncol = 1) + 
  ggsave(filename = "figures/pca-datasets-mean.pdf",height=4.5,width=4.5)

plot_grid(
  ggplot(variance_pca_output$wbc,aes(x = PC1,y = PC2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("PC1") + 
    ylab("PC2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("PCA input: WBC variance"),
  ggplot(variance_pca_output$rbc,aes(x = PC1,y = PC2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("PC1") + 
    ylab("PC2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("PCA input: RBC variance"),
  ggplot(variance_pca_output$wbc_rbc,aes(x = PC1,y = PC2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("PC1") + 
    ylab("PC2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("PCA input: concatenated WBC and RBC variances"),
  ncol = 1) + 
  ggsave(filename = "figures/pca-datasets-variance.pdf",height=4.5,width=4.5)
```

There is a relatively clear shift for both WBC mean and variance. This shift is worse in RBC.

```{r}
RBC_subset <- RBC_cells[sample(nrow(RBC_cells),12500),]
WBC_subset <- WBC_cells[sample(nrow(WBC_cells),12500),]

cells_pca <- pca_cells(
  RBC_subset,WBC_subset,Merge = F)

wbc_lims <- list(x = quantile(cells_pca$wbc$PC1,c(0.01,0.99)),
                 y = quantile(cells_pca$wbc$PC2,c(0.01,0.99)))
rbc_lims <- list(x = quantile(cells_pca$rbc$PC1,c(0.01,0.99)),
                 y = quantile(cells_pca$rbc$PC2,c(0.01,0.99)))
```

```{r,fig.width=6,fig.height=6}
plot_grid(
  ggplot(cells_pca$wbc,aes(x = PC1,y = PC2,colour = dataset)) + 
    geom_point(alpha = 0.4,size = 0.1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("PC1") + 
    ylab("PC2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) +
    coord_cartesian(xlim = wbc_lims$x,ylim = wbc_lims$y) + 
    scale_x_continuous(expand = c(0.2,0)) + 
    scale_y_continuous(expand = c(0.2,0)) + 
    ggtitle("PCA input: WBC features"),
  ggplot(cells_pca$rbc,aes(x = PC1,y = PC2,colour = dataset)) + 
    geom_point(alpha = 0.4,size = 0.1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("PC1") + 
    ylab("PC2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) +
    theme(legend.key.size = unit(0,"cm")) +
    coord_cartesian(xlim = rbc_lims$x,ylim = rbc_lims$y) + 
    scale_x_continuous(expand = c(0.2,0)) + 
    scale_y_continuous(expand = c(0.2,0)) + 
    ggtitle("PCA input: RBC features"),
  ncol = 1) + 
  ggsave(filename = "figures/pca-datasets-cells.pdf",height = 6,width = 6)

plot_grid(
  ggplot(cells_pca$wbc,aes(x = PC1,y = PC2,colour = dataset)) + 
    geom_density2d(size = 0.25) + 
    geom_point(alpha = 0.4,size = 0.1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("PC1") + 
    ylab("PC2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) +
    coord_cartesian(xlim = wbc_lims$x,ylim = wbc_lims$y) + 
    scale_x_continuous(expand = c(0.3,0)) + 
    scale_y_continuous(expand = c(0.3,0)) + 
    ggtitle("PCA input: WBC features"),
  ggplot(cells_pca$rbc,aes(x = PC1,y = PC2,colour = dataset)) + 
    geom_density2d(size = 0.25) + 
    geom_point(alpha = 0.4,size = 0.1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("PC1") + 
    ylab("PC2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) +
    theme(legend.key.size = unit(0,"cm")) +
    coord_cartesian(xlim = rbc_lims$x,ylim = rbc_lims$y) + 
    scale_x_continuous(expand = c(0.3,0)) + 
    scale_y_continuous(expand = c(0.3,0)) + 
    ggtitle("PCA input: RBC features"),
  ncol = 1) + 
  ggsave(filename = "figures/pca-datasets-cells-density.pdf",height = 6,width = 6)
```

This shift in data distribution is hard to pick up from the first two components. However, for RBC it looks more evident than for WBC.

### UMAP

```{r,fig.height=4.5,fig.width=4.5}
RBC_data <- RBC_data_all %>% 
  subset(moment == "mean")
WBC_data <- WBC_data_all %>%
  subset(moment == "mean")
mean_umap_output <- umap_cells(RBC_data,WBC_data,m=0.9)

RBC_data <- RBC_data_all %>% 
  subset(moment == "variance")
WBC_data <- WBC_data_all %>%
  subset(moment == "variance")
variance_umap_output <- umap_cells(RBC_data,WBC_data,m=0.9)

RBC_data_mean <- RBC_data_all %>% 
  subset(moment == "mean")
WBC_data_mean <- WBC_data_all %>%
  subset(moment == "mean")
RBC_data_variance <- RBC_data_all %>% 
  subset(moment == "variance")
WBC_data_variance <- WBC_data_all %>%
  subset(moment == "variance")
colnames(RBC_data_variance) <- paste0(colnames(RBC_data_variance),'_var')
colnames(WBC_data_variance) <- paste0(colnames(WBC_data_variance),'_var')

RBC_data <- cbind(RBC_data_mean,RBC_data_variance)
WBC_data <- cbind(WBC_data_mean,WBC_data_variance)
both_umap_output <- umap_cells(RBC_data,WBC_data,m=0.9)

plot_grid(
  ggplot(mean_umap_output$wbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("UMAP input: WBC mean"),
  ggplot(mean_umap_output$rbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("UMAP input: RBC mean"),
  ggplot(mean_umap_output$wbc_rbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("UMAP input: concatenated WBC and RBC means"),
  ncol = 1) + 
  ggsave(filename = "figures/umap-datasets-mean.pdf",height=4.5,width=4.5)

plot_grid(
  ggplot(variance_umap_output$wbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("UMAP input: WBC variance"),
  ggplot(variance_umap_output$rbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("UMAP input: RBC variance"),
  ggplot(variance_umap_output$wbc_rbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("UMAP input: concatenated WBC and RBC variances"),
  ncol = 1) + 
  ggsave(filename = "figures/umap-datasets-variance.pdf",height=4.5,width=4.5)

plot_grid(
  ggplot(both_umap_output$wbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("UMAP input: WBC  distribution parameters"),
  ggplot(both_umap_output$rbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("UMAP input: RBC  distribution parameters"),
  ggplot(both_umap_output$wbc_rbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 1) + 
    facet_wrap(~ coarse_class) +
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) + 
    ggtitle("UMAP input: concatenated WBC and RBC distribution parameters"),
  ncol = 1) + 
  ggsave(filename = "figures/umap-datasets-both.pdf",height=4.5,width=4.5)
```

```{r,fig.height=1.1,fig.width=4.5}
both_umap_output <- umap_cells(RBC_data[RBC_data$dataset != "AC1",],WBC_data[WBC_data$dataset != "AC1",],m=0.9)

plot_grid(
  ggplot(both_umap_output$wbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 0.25) + 
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")),
  ggplot(both_umap_output$rbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 0.25) + 
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")),
  ggplot(both_umap_output$wbc_rbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 0.25) + 
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")),
  ncol = 3) + 
  ggsave(filename = "figures/umap-datasets-both-no-facet.pdf",height=1.1,width=4.5)
```

The shift in distribution is particularly visibile in a UMAP projection for both cell types. Particularly, it would appear that samples from AC2 (digitalised with a different scanner) are particularly different from those in both AC1 and MLL, which themselves show some slight difference between them (different forms of slide preparation). 

```{r}
RBC_subset <- RBC_cells[sample(nrow(RBC_cells),12500),]
WBC_subset <- WBC_cells[sample(nrow(WBC_cells),12500),]

cells_umap <- umap_cells(
  RBC_subset,WBC_subset,m = 0.99,Merge = F)

wbc_lims <- list(x = quantile(cells_umap$wbc$V1,c(0.01,0.99)),
                 y = quantile(cells_umap$wbc$V2,c(0.01,0.99)))
rbc_lims <- list(x = quantile(cells_umap$rbc$V1,c(0.01,0.99)),
                 y = quantile(cells_umap$rbc$V2,c(0.01,0.99)))
```

```{r,fig.width=5,fig.height=2.5}
plot_grid(
  ggplot(cells_umap$wbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.4,size = 0.1) + 
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) +
    coord_cartesian(xlim = wbc_lims$x,ylim = wbc_lims$y) + 
    scale_x_continuous(expand = c(0.2,0)) + 
    scale_y_continuous(expand = c(0.2,0)) + 
    ggtitle("UMAP input: WBC features"),
  ggplot(cells_umap$rbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.4,size = 0.1) + 
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) +
    theme(legend.key.size = unit(0,"cm")) +
    coord_cartesian(xlim = rbc_lims$x,ylim = rbc_lims$y) + 
    scale_x_continuous(expand = c(0.2,0)) + 
    scale_y_continuous(expand = c(0.2,0)) + 
    ggtitle("UMAP input: RBC features"),
  ncol = 2) + 
  ggsave(filename = "figures/umap-datasets-cells.pdf",height = 2.5,width = 5)

plot_grid(
  ggplot(cells_umap$wbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_density2d(size = 0.25) + 
    geom_point(alpha = 0.2,size = 0.1) + 
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) +
    coord_cartesian(xlim = wbc_lims$x,ylim = wbc_lims$y) + 
    scale_x_continuous(expand = c(0.3,0)) + 
    scale_y_continuous(expand = c(0.3,0)) + 
    ggtitle("UMAP input: WBC features"),
  ggplot(cells_umap$rbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_density2d(size = 0.25) + 
    geom_point(alpha = 0.2,size = 0.1) + 
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")) +
    theme(legend.key.size = unit(0,"cm")) +
    coord_cartesian(xlim = rbc_lims$x,ylim = rbc_lims$y) + 
    scale_x_continuous(expand = c(0.3,0)) + 
    scale_y_continuous(expand = c(0.3,0)) + 
    ggtitle("UMAP input: RBC features"),
  ncol = 2) + 
  ggsave(filename = "figures/umap-datasets-cells-density.pdf",height = 2.5,width = 5)
```

The same is observable for both WBC and RBC when inspecting the UMAP projection of individual cells. 

```{r}
RBC_subset <- RBC_cells[RBC_cells$dataset != "AC1",]
WBC_subset <- WBC_cells[WBC_cells$dataset != "AC1",]
RBC_subset <- RBC_subset[sample(nrow(RBC_subset),12500),]
WBC_subset <- WBC_subset[sample(nrow(WBC_subset),12500),]

cells_umap <- umap_cells(
  RBC_subset,WBC_subset,m = 0.99,Merge = F)

wbc_lims <- list(x = quantile(cells_umap$wbc$V1,c(0.01,0.99)),
                 y = quantile(cells_umap$wbc$V2,c(0.01,0.99)))
rbc_lims <- list(x = quantile(cells_umap$rbc$V1,c(0.01,0.99)),
                 y = quantile(cells_umap$rbc$V2,c(0.01,0.99)))
```

# Dataset shift - inspecting possible solutions

The evidence presented above suggests that dataset shift is considerable between different datasets. It is worth noting that each was acquired under different conditions --- particularly, MLL and AC1 were both acquired using a Hamamatsu machine but were prepared manually and automatically, respectively, whereas AC2 was digitalised using an Advia scanner and prepared manually. Dataset shift can better understood in formal terms when we consider the objective of prediction --- estimating $P(X,Y)$. In these terms, dataset shift characterizes a change $P(X)$, whereas the mapping function ($P(y|X)$) remains the same.

A few possible solutions (or ameliorations) can be listed below, each of which requires access to the external validation cohort (a non-ideal scenario):

  * **Restandardizing the external validation data.** The implication behind this is that the data distribution ($P(X)$) is different between MLL and AC2, but the distribution of the labels given the data ($P(y|X)$) is comparable
  * **Altering the feature range such that both datasets have the same range for each feature.** The implication behind this is the same as before, but the change in $P(X)$ is different
  * **Calculating ratio between WBC and RBC features.** This was concieved as "slide-specific" method of normalization - if the dataset shift affects both WBC and RBC equally, their ratio should remain roughly the same
  * **Unbiased features.** Using a simple rank based test to compare features between two datasets it is possible to derive an AUC-equivalent metric that assigns to each feature their dataset-predictive power. By removing these, we get a set of features that is not biased by the dataset

For each, I first assess whether or not the distribution they originate is unbiased through the inspection of a UMAP. If I verify that the distribution is not biased for the dataset, I retrain the prediction algorithm.

## Restandardizing the external validation data

This is the simplest one - I standardize both datasets independently so they both have mean 0 and standard deviation 1. 

```{r}
a <- scale(full_dataset_collection$data$morphology)
b <- scale(full_dataset_collection_oos$data$morphology)

restandardize_umap <- rbind(a,b) %>%
  umap 
restandardize_umap_df <- as.data.frame(as.matrix(restandardize_umap$layout))
restandardize_umap_df$dataset <- c(
  rep("MLLC",nrow(a)),rep("AC2",nrow(b)))
restandardize_umap_df$coarse_class <- c(
  as.character(full_dataset_collection$coarse_labels),
  as.character(full_dataset_collection_oos$coarse_labels))

ggplot(restandardize_umap_df,aes(x = V1,y = V2,colour = dataset)) + 
  geom_point(alpha = 0.5,size = 1) + 
  facet_wrap(~ coarse_class) +
  theme_pretty(base_size = 6) + 
  xlab("UMAP1") + 
  ylab("UMAP2") + 
  scale_colour_jama(name = NULL) + 
  theme(legend.key.size = unit(0,"cm"))
```

While this works relatively well for slides from individuals with anaemia or MDS, its effects are poor when slides from control (or "normal") individuals are concerned. 

## Rescaling the external validation data

Here I scale both datasets using the same transformation after rescaling the validation dataset so that it has the same range as the training dataset.

```{r}
match_min_max <- function(df1,df2) {
  # match the min and max of all columns in df2 to those of d1
  CC <- colnames(df2)
  m <- matrix(apply(df2,2,min,na.rm=T),nrow=1)
  M <- matrix(apply(df2,2,max,na.rm=T),nrow=1)
  df2 <- t(apply(df2,1,function(x) (x - m)/(M-m)))
  m <- matrix(apply(df1,2,min,na.rm=T),nrow=1)
  M <- matrix(apply(df1,2,max,na.rm=T),nrow=1)
  r <- M-m
  df2 <- t(apply(df2,1,function(x) x * r + m))
  df2 <- as.data.frame(df2)
  colnames(df2) <- CC
  return(df2)
}

pp <- preProcess(full_dataset_collection$data$morphology)
a <- predict(pp,full_dataset_collection$data$morphology)
b <- predict(pp,match_min_max(full_dataset_collection$data$morphology,full_dataset_collection_oos$data$morphology))

rescaling_umap <- rbind(a,b) %>%
  scale %>% 
  umap 
rescaling_umap_df <- as.data.frame(as.matrix(rescaling_umap$layout))
rescaling_umap_df$dataset <- c(
  rep("MLLC",nrow(a)),rep("AC2",nrow(b)))
rescaling_umap_df$coarse_class <- c(
  as.character(full_dataset_collection$coarse_labels),
  as.character(full_dataset_collection_oos$coarse_labels))

ggplot(rescaling_umap_df,aes(x = V1,y = V2,colour = dataset)) + 
  geom_point(alpha = 0.5,size = 1) + 
  facet_wrap(~ coarse_class) +
  theme_pretty(base_size = 6) + 
  xlab("UMAP1") + 
  ylab("UMAP2") + 
  scale_colour_jama(name = NULL) + 
  theme(legend.key.size = unit(0,"cm"))
```

This method does not show any form of improvement as far as dataset shift is concerned. 

## WBC/RBC ratios

The first possibility was to calculate the ratio between WBC and RBC features, implicating that feature shifts were similar. However, this does not ameliorate in any form the disparity observed - by inspecting the UMAP, it is clear that there still is a considerable clustering by dataset.

```{r}
a <- full_dataset_collection$data$morphology[
  ,grepl("RBC",colnames(full_dataset_collection$data$morphology))]
b <- full_dataset_collection$data$morphology[
  ,grepl("WBC",colnames(full_dataset_collection$data$morphology))]
b <- b[,!grepl("nuclear",colnames(b))]
rbc_pp <- preProcess(a,method=c("center","scale"))
wbc_pp <- preProcess(b,method=c("center","scale"))
wbc_rbc_ratios <- predict(wbc_pp,b) / predict(rbc_pp,a)
wbc_rbc_ratios <- b / a

testing_a <- full_dataset_collection_oos$data$morphology[
  ,grepl("RBC",colnames(full_dataset_collection_oos$data$morphology))]
testing_b <- full_dataset_collection_oos$data$morphology[
  ,grepl("WBC",colnames(full_dataset_collection_oos$data$morphology))]
testing_b <- testing_b[,!grepl("nuclear",colnames(testing_b))]
wbc_rbc_ratios_test <- predict(wbc_pp,testing_b) / predict(rbc_pp,testing_a)
wbc_rbc_ratios_test <- testing_b / testing_a

training_y <- full_dataset_collection$fine_labels
testing_y <- full_dataset_collection_oos$fine_labels

ratio_umap <- rbind(
  wbc_rbc_ratios,
  wbc_rbc_ratios_test
) %>%
  scale %>%
  umap 
ratio_umap_df <- as.data.frame(as.matrix(ratio_umap$layout))
ratio_umap_df$dataset <- c(
  rep("MLLC",nrow(wbc_rbc_ratios)),rep("AC2",nrow(wbc_rbc_ratios_test)))
ratio_umap_df$coarse_class <- c(full_dataset_collection$coarse_labels,full_dataset_collection_oos$coarse_labels)

ggplot(ratio_umap_df,aes(x = V1,y = V2,colour = dataset)) + 
  geom_point(alpha = 0.5,size = 1) + 
  facet_wrap(~ coarse_class) +
  theme_pretty(base_size = 6) + 
  xlab("UMAP1") + 
  ylab("UMAP2") + 
  scale_colour_jama(name = NULL) + 
  theme(legend.key.size = unit(0,"cm"))
```

## Excluding features which are predictive of dataset

Here I exclude features which have some predictive power (either AUC < 0.33 or AUC > 0.66) in terms of predicting the dataset from which the data originated. 

```{r,fig.height=1.1,fig.width=4.5}
n1 <- nrow(full_dataset_collection$data$morphology)
n2 <- nrow(full_dataset_collection_oos$data$morphology)

combined_datasets <- rbind(
  mutate(full_dataset_collection$data$morphology,dataset="MLLC"),
  mutate(full_dataset_collection_oos$data$morphology,dataset="AC2")
) 

dataset_AUC_values <- 1:(ncol(combined_datasets)-1) %>% 
  sapply(function(x) {
  df <- data.frame(
    value = combined_datasets[,x],
    dataset = combined_datasets$dataset
  )
  a <- wilcox.test(value ~ dataset,data = df,paired=F)
  return(a$statistic / (n1*n2))
})

features_to_keep <- which(
  dataset_AUC_values < 2/3 & dataset_AUC_values > 1/3)

features_to_keep_dt <- list(
  bcdem = grep("*",colnames(full_dataset_collection$data$bcdem)),
  morphology = features_to_keep,
  full = c(features_to_keep,grep("BCDEM",colnames(full_dataset_collection$data$full)))
)

fdc <- rbind(
  full_dataset_collection$data$morphology[,features_to_keep],
  full_dataset_collection_oos$data$morphology[,features_to_keep]) %>%
  mutate(slide_id = c(full_dataset_collection$slide_id,full_dataset_collection_oos$slide_id),
         coarse_class = c(full_dataset_collection$coarse_labels,full_dataset_collection_oos$coarse_labels),
         fine_class = c(full_dataset_collection$fine_labels,full_dataset_collection_oos$fine_labels),
         dataset = c(rep("MLLC",length(full_dataset_collection$slide_id)),rep("AC2",length(full_dataset_collection_oos$slide_id))))

RBC_features_to_keep <- fdc[
  ,c("slide_id","coarse_class","fine_class","dataset",colnames(fdc)[grepl("RBC",colnames(fdc))])
]
WBC_features_to_keep <- fdc[
  ,c("slide_id","coarse_class","fine_class","dataset",colnames(fdc)[grepl("WBC",colnames(fdc))])
]
auc_filtered_umap <- umap_cells(RBC_features_to_keep,WBC_features_to_keep,m = 0.9)

plot_grid(
  ggplot(auc_filtered_umap$wbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 0.25) + 
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")),
  ggplot(auc_filtered_umap$rbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 0.25) + 
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")),
  ggplot(auc_filtered_umap$wbc_rbc,aes(x = V1,y = V2,colour = dataset)) + 
    geom_point(alpha = 0.5,size = 0.25) + 
    theme_pretty(base_size = 6) + 
    xlab("UMAP1") + 
    ylab("UMAP2") + 
    scale_colour_jama(name = NULL) + 
    theme(legend.key.size = unit(0,"cm")),
  ncol = 3) + 
  ggsave(filename = "figures/umap-datasets-both-no-facet-unbiased.pdf",height=1.1,width=4.5)
```

```{r,fig.height=1.5,fig.width=3}
plot_grid(
  data.frame(features = colnames(combined_datasets)[1:ncol(combined_datasets)-1],
             AUC = dataset_AUC_values) %>%
    mutate(cell_type = ifelse(grepl("RBC",features),"RBC","WBC")) %>%
    ggplot(aes(x = features,y = AUC)) + 
    geom_point(size = 0.5) + 
    annotate(x = 90,y = 2/3 + 1/6,height = 1/3,width = 200,
             geom = "tile",inherit.aes=F,
             alpha = 0.5,fill = "grey") +
    annotate(x = 90,y = 1/6,height = 1/3,width = 200,
             geom = "tile",inherit.aes=F,
             alpha = 0.5,fill = "grey") +
    theme_pretty(base_size = 6) + 
    facet_wrap(~ cell_type) + 
    geom_hline(yintercept = 1/3,linetype = 2,size = 0.25) + 
    geom_hline(yintercept = 2/3,linetype = 2,size = 0.25) + 
    xlab("Features") + 
    theme(axis.text.x = element_blank(),axis.ticks.x = element_blank()) + 
    scale_y_continuous(expand = c(0,0)),
  data.frame(features = colnames(combined_datasets)[1:ncol(combined_datasets)-1],
             AUC = dataset_AUC_values) %>%
    mutate(cell_type = ifelse(grepl("RBC",features),"RBC","WBC")) %>%
    mutate(keep = AUC > 1/3 & AUC < 2/3) %>%
    group_by(cell_type) %>%
    mutate(Total = length(unique(features))) %>%
    group_by(keep,cell_type,Total) %>%
    summarise(N = length(unique(features))) %>%
    ggplot(aes(x = cell_type,y = N/Total,fill = keep)) + 
    geom_bar(stat = "identity") + 
    theme_pretty(base_size = 6) + 
    scale_y_continuous(expand = c(0,0)) + 
    theme(legend.position = "bottom",legend.key.size = unit(0.2,"cm"),
          axis.title.x = element_blank(),legend.margin = unit(0,"cm")) + 
    guides(fill = guide_legend(nrow = 2)) + 
    scale_fill_aaas(name = NULL,labels = c("Discarded","Kept")) + 
    ylab("Fraction of features"),
  align = "hv",
  axis = "tb",
  rel_widths = c(1,0.5)
) + 
  ggsave("figures/auc-discarded.pdf",height = 1.5,width = 3)
```

After observing that this, naturally, eliminates the clear segregation between datasets, I retrain the predictive models using the subset of poorly predictive features in terms of dataset prediction. 

```{r}
set.seed(123)
scales <- list()
stratified_folds <- make_folds(full_dataset_collection$fine_labels,k = K)
scales <- list(
  full = lapply(
    stratified_folds,
    function(x) {
      pp <- preProcess(full_dataset_collection$data$full[
        x$train,features_to_keep_dt$full],
                       method = c("center","scale","corr","nzv","medianImpute"))
      return(pp)}),
  morphology = lapply(
    stratified_folds,
    function(x) {
      pp <- preProcess(full_dataset_collection$data$morphology[
        x$train,features_to_keep_dt$morphology],
                       method = c("center","scale","corr","nzv","medianImpute"))
      return(pp)}),
  bcdem = lapply(
    stratified_folds,
    function(x) {
      pp <- preProcess(full_dataset_collection$data$bcdem[
        x$train,features_to_keep_dt$bcdem],
        method = c("center","scale","corr","nzv","medianImpute"))
      return(pp)}))

glmnet_models <- list()
for (data_type in c("bcdem","morphology","full")) {
  for (ID in IDs) {
    glmnet_models[[data_type]][[ID]] <- list()
    
    for (i in 1:K) {
      print(sprintf("Training fold = %s (glmnet; %s with %s)",i,ID,data_type))
      
      # define folds and training/validation sets
      glmnet_models[[data_type]][[ID]][[i]] <- list()
      fold <- stratified_folds[[i]]
      training_X <- full_dataset_collection$data[[data_type]][
        fold$train,features_to_keep_dt[[data_type]]] %>%
        as.matrix
      training_y <- label_conversion[[ID]][
        full_dataset_collection$fine_labels[fold$train]]
      NA_train <- is.na(training_y)
      training_X <- training_X[!NA_train,]
      training_y <- training_y[!NA_train]
      
      testing_X <- full_dataset_collection$data[[data_type]][
        fold$test,features_to_keep_dt[[data_type]]] %>%
        as.matrix
      testing_y <- label_conversion[[ID]][
        full_dataset_collection$fine_labels[fold$test]]
      NA_test <- is.na(testing_y)
      testing_X <- testing_X[!NA_test,]
      testing_y <- testing_y[!NA_test]
      
      # calculate class weights
      class_weights <- make_class_weights(training_y)
      
      # scaling
      pp <- scales[[data_type]][[i]]
      training_X <- predict(pp,training_X)
      testing_X <- predict(pp,testing_X)
      
      # training and inference for training and validation sets
      alphas <- c(0.01,0.1,0.25,0.5,0.75,0.9,0.99)
      models <- list()
      for (alpha in alphas) {
        m <- cv.glmnet(
          training_X,training_y,family = "binomial",type.measure = "auc",
          nfolds = 5,weights = class_weights,alpha = alpha)
        l <- m$lambda
        l.min <- m$lambda.min
        models[[as.character(alpha)]]$model <- m
        models[[as.character(alpha)]]$metric <- m$cvm[l == l.min]
      }
      best_model_idx <- lapply(models,function(x) x$metric) %>%
        unlist
      if (m$name == "Binomial Deviance") {
        best_model_idx <- which.min(best_model_idx)
      } else {
        best_model_idx <- which.max(best_model_idx)
      }
      trained_model <- models[[best_model_idx]]$model
      
      train_proba_pred <- predict(trained_model,
                                  newx = training_X,type = "response")
      train_class_pred <- predict(trained_model,
                                  newx = training_X,type = "class")
      
      test_proba_pred <- predict(trained_model,
                                 newx = testing_X,type = "response")
      test_class_pred <- predict(trained_model,
                                 newx = testing_X,type = "class")
      
      glmnet_models[[data_type]][[ID]][[i]]$model <- trained_model
      glmnet_models[[data_type]][[ID]][[i]]$metrics <- list(
        Training = list(
          ConfusionMatrix = confusionMatrix(table(
            reverse_label_conversion[[ID]][as.numeric(train_class_pred)+1],
            reverse_label_conversion[[ID]][training_y+1])),
          AUC = roc(reverse_label_conversion[[ID]][training_y+1],
                    train_proba_pred[,1],quiet = T,
                    levels = reverse_label_conversion[[ID]])),
        Validation = list(
          ConfusionMatrix = confusionMatrix(table(
            reverse_label_conversion[[ID]][as.numeric(test_class_pred)+1],
            reverse_label_conversion[[ID]][testing_y+1])),
          AUC = roc(reverse_label_conversion[[ID]][testing_y+1],
                    test_proba_pred[,1],quiet = T,
                    levels = reverse_label_conversion[[ID]])))
    }
  }
}
```

```{r}
all_roc <- list()
roc_list <- list()
for (data_type in c("bcdem","morphology","full")) {
  for (ID in IDs) {
    all_probs_preds <- glmnet_models[[data_type]][[ID]] %>%
      lapply(function(x) {
        x$metrics$Validation$AUC[c("original.predictor","original.response")]}) %>%
      lapply(function(x) return(do.call(cbind,x))) %>%
      do.call(what = rbind) %>%
      as.data.frame
    all_probs_preds$original.predictor <- all_probs_preds$original.predictor %>%
      as.character %>% as.numeric()
    full_roc <- roc(all_probs_preds$original.response,
                    all_probs_preds$original.predictor,quiet = T)
    tmp <- get.coords.for.ggplot(full_roc) %>%
      as.tibble %>%
      mutate(data_type = data_type)
    all_roc[[paste(data_type,ID,sep="_")]] <- tmp
    all_roc[[paste(data_type,ID,sep="_")]]$task <- ID
    all_roc[[paste(data_type,ID,sep="_")]]$auc_value <- full_roc$auc
    roc_list[[paste(data_type,ID)]] <- full_roc
  }
}

all_roc_df <- do.call(rbind,all_roc) %>%
  subset(is.finite(threshold)) %>%
  arrange(-threshold) %>%
  mutate(task = factor(task,
                       levels = c("disease_detection","disease_classification",
                                  "sf3b1","anaemia_classification"),
                       labels = c("Disease detection","Disease classification",
                                  "SF3B1mut detection","Anaemia classification"))) %>%
  mutate(data_type = factor(data_type,levels = c("bcdem","morphology","full"),
                            labels = c("B.C.","Morphology","Morphology + B.C.")))

ggplot(all_roc_df,aes(colour = data_type)) + 
  geom_abline(slope = 1,intercept = 0,size = 0.25,linetype = 2,alpha = 0.5) +
  geom_line(aes(x = 1-specificity,y = sensitivity),alpha = 0.7,size = 0.5) + 
  facet_wrap(~ task) + 
  theme_pretty(base_size = 6) + 
  scale_colour_manual(values = c("blue4","red4","orange"),name = NULL) + 
  theme(legend.position = "bottom",
        legend.key.height = unit(0.1,"cm"),
        legend.key.width = unit(0.2,"cm"),
        panel.spacing = unit(0.8,"lines")) +
  coord_cartesian(xlim = c(0,1),ylim = c(0,1)) + 
  scale_x_continuous(expand = c(0.01,0.01)) +
  scale_y_continuous(expand = c(0.01,0.01))

all_roc_df %>%
  select(task,data_type,auc_value) %>%
  distinct %>%
  ggplot(aes(x = reorder(task,desc(task)),y = auc_value, fill = data_type)) + 
  geom_bar(stat = "identity",position = position_dodge(width = 0.9)) + 
  geom_text(aes(label = sprintf("%.1f%%",auc_value*100)),
            position = position_dodge(width = 0.9),
            hjust = -0.1,size = 2) +
  theme_pretty(base_size = 6) + 
  scale_fill_manual(values = c("blue4","red4","orange"),name = NULL) + 
  theme(legend.position = "bottom",
        axis.title.y = element_blank(),
        legend.key.height = unit(0.1,"cm"),
        legend.key.width = unit(0.2,"cm")) +
  scale_x_discrete() +
  ylab("Area under the curve") +
  coord_flip(ylim = c(0.5,1)) + 
  scale_y_continuous(expand = c(0,0,0.02,0.02))
```

While this approach does indeed eliminate discrepancies between datasets, it also removes part of the signal associated with *SF3B1* mutation detection according to cross-validated scores while keeping similar external validation scores as presented below. 

```{r}
data_types <- c("morphology","full","bcdem")

validation_aucs <- list()
all_roc_val <- list()

for (data_type in data_types) {
  for (ID in IDs) {
    best_model_idx <- lapply(
      glmnet_models[[data_type]][[ID]],
      function(x) c(
        as.numeric(x$metrics$Validation$AUC$auc))) %>%
      which.max
    best_model <- glmnet_models[[data_type]][[ID]][[best_model_idx]]$model
    ground_truth <- label_conversion[[ID]][full_dataset_collection_oos$fine_labels]
    scaler <- scales[[data_type]][[best_model_idx]]
    d <- full_dataset_collection_oos$data[[data_type]][
      ,features_to_keep_dt[[data_type]]]
    d <- as.matrix(predict(scaler,d))

    class_prediction <- predict(best_model,type = "class",newx = d)[,1]
    prob_prediction <- predict(best_model,type = "response",newx = d)[,1]
    dat <- data.frame(
      pred = reverse_label_conversion[[ID]][as.numeric(class_prediction)+1],
      obs = reverse_label_conversion[[ID]][ground_truth+1],
      prob = prob_prediction
    ) %>%
      na.omit
    dat$pred <- factor(dat$pred,levels = reverse_label_conversion[[ID]])
    dat$obs <- factor(dat$obs,levels = reverse_label_conversion[[ID]])
    roc_curve <- roc(dat$obs,dat$prob)
    validation_aucs[[paste(data_type,ID,sep="_")]] <- data.frame(
      auc_value = roc_curve$auc,
      task = c(disease_detection = "Disease detection",
               disease_classification = "Disease classification",
               sf3b1 = "SF3B1mut detection",
               anaemia_classification = "Anaemia classification")[ID],
      data_type = data_type,
      N = nrow(dat)
    ) %>%
      mutate(NP = length(roc_curve$cases),NN = length(roc_curve$controls))
    tmp <- get.coords.for.ggplot(roc_curve) %>%
      as.tibble %>%
      mutate(data_type = data_type)
    all_roc_val[[paste(data_type,ID,sep="_")]] <- tmp
    all_roc_val[[paste(data_type,ID,sep="_")]]$task <- ID
    all_roc_val[[paste(data_type,ID,sep="_")]]$auc_value <- full_roc$auc
  }
}

all_roc_val_df <- do.call(rbind,all_roc_val) %>%
  subset(is.finite(threshold)) %>%
  arrange(-threshold) %>%
  mutate(task = factor(task,
                       levels = c("disease_detection","disease_classification",
                                  "sf3b1","anaemia_classification"),
                       labels = c("Disease detection","Disease classification",
                                  "SF3B1mut detection","Anaemia classification"))) %>%
  mutate(data_type = factor(data_type,levels = c("bcdem","morphology","full"),
                            labels = c("B.C.","Morphology","Morphology + B.C.")))

validation_aucs_df <- do.call(what = rbind,validation_aucs) %>%
  mutate(data_type = factor(data_type,levels = c("bcdem","morphology","full"),
                            labels = c("B.C.","Morphology","Morphology + B.C.")))

rbind(
  mutate(all_roc_val_df,type = "Independent validation set"),
  mutate(all_roc_df,type = "Cross-validated")
) %>%
  ggplot(aes(colour = data_type)) + 
  geom_abline(slope = 1,intercept = 0,size = 0.25,linetype = 3,alpha = 0.5) +
  geom_line(aes(x = 1-specificity,y = sensitivity,linetype = type),alpha = 0.7,size = 0.25) + 
  facet_wrap(~ task) + 
  theme_pretty(base_size = 6) + 
  scale_colour_manual(values = c("blue4","red4","orange"),name = NULL,guide = F) + 
  theme(legend.position = "bottom",
        legend.key.height = unit(0.1,"cm"),
        legend.key.width = unit(0.2,"cm"),
        panel.spacing = unit(0.8,"lines")) +
  coord_cartesian(xlim = c(0,1),ylim = c(0,1)) + 
  scale_x_continuous(expand = c(0.01,0.01)) +
  scale_y_continuous(expand = c(0.01,0.01)) +
  scale_linetype_manual(name = NULL,values = c(1,2)) +
  guides(linetype = guide_legend(nrow = 2))

all_roc_df %>%
  select(task,data_type,auc_value) %>%
  distinct %>%
  ggplot(aes(x = reorder(task,desc(task)),y = auc_value, fill = data_type)) + 
  geom_bar(stat = "identity",position = position_dodge(width = 0.9)) + 
  geom_linerange(data = validation_aucs_df,position = position_dodge(width = 0.9),
                 aes(ymin = auc_value - 1/sqrt(N),
                     ymax = min(auc_value + 1/sqrt(N),1)),
                 alpha = 1,size = 0.5,shape = 5) + 
  geom_point(data = validation_aucs_df,position = position_dodge(width = 0.9),
             alpha = 1,size = 2,shape = 18,colour = "white") + 
  geom_point(data = validation_aucs_df,position = position_dodge(width = 0.9),
             alpha = 1,size = 2,shape = 5) + 
  theme_pretty(base_size = 6) + 
  scale_fill_manual(values = c("blue4","red4","orange"),name = NULL) + 
  theme(legend.position = "bottom",
        axis.title.y = element_blank(),
        legend.key.height = unit(0.1,"cm"),
        legend.key.width = unit(0.2,"cm")) +
  scale_x_discrete() +
  ylab("Area under the curve") +
  coord_flip(ylim = c(0.5,1)) + 
  scale_y_continuous(expand = c(0,0,0.02,0.02)) + 
  scale_color_discrete(guide = F) +
  ggsave(filename = "figures/auc-bars-w-validation-unbiased.pdf",height=1.7,width=3)
```

```{r}
feature_associations <- list()

for (data_type in c("bcdem","morphology","full")) {
  cat("\n")
  for (ID in IDs) {
    all_coefs_glmnet <- c(1:K) %>% 
      lapply(function(x) {
        C <- as.matrix(coef(glmnet_models[[data_type]][[ID]][[x]]$model))
        o <- data.frame(features = rownames(C),coef = unlist(C[,1]),fold = x)
        rownames(o) <- NULL
        return(o)}) %>%
      do.call(what = rbind) %>%
      mutate(model = "glmnet")
    non_zero_feature_association_df <- rbind(all_coefs_glmnet) %>%
      group_by(model,features) %>%
      summarise(f = mean(coef,na.rm=T),.groups = "drop") %>%
      spread(key = "model",value = "f") %>%
      na.omit() %>%
      mutate(sign_glmnet = sign(glmnet),glmnet = abs(glmnet))
    
    feature_associations[[paste(ID,data_type)]] <- non_zero_feature_association_df %>%
      mutate(task = ID,data_type = data_type)
  }
}

feature_associations_df <- feature_associations %>%
  do.call(what = rbind) %>%
  #subset(glmnet > 0 & RRF > 0) %>%
  mutate(task = factor(task,
                       levels = c("disease_detection","disease_classification",
                                  "sf3b1","anaemia_classification"),
                       labels = c("Disease detection","Disease classification",
                                  "SF3B1mut detection","Anaemia classification"))) %>%
  mutate(WBC = grepl("WBC",features),
         RBC = grepl("RBC",features),
         means = grepl("means",features),
         variances = grepl("vars",features)) %>% 
  mutate(cell_type = ifelse(WBC,"WBC",ifelse(RBC,"RBC","B.C.")),
         moment = ifelse(means,"Mean",ifelse(variances,"Variance","X"))) %>%
  mutate(features_raw = gsub('\\.','',str_match(features,'[a-z_A-Z0-9]+\\.')))

feature_no <- seq(1,length(features_conversion))
names(feature_no) <- names(features_conversion)

file_connection <- file("data_output/wbc_feature_subset_unbiased")
feature_associations_df %>% 
  subset(glmnet > 0.01) %>%
  subset(data_type == "full" & cell_type == "WBC") %>% 
  select(features_raw) %>%
  distinct %>%
  mutate(features_raw = feature_no[features_raw]) %>%
  unlist %>%
  sort %>%
  paste(collapse = ',') %>%
  writeLines(file_connection)
close(file_connection)
file.copy("data_output/wbc_feature_subset_unbiased",
          "../mile-vice/scripts/wbc_feature_subset_unbiased",
          overwrite = T)

file_connection <- file("data_output/rbc_feature_subset_unbiased")
feature_associations_df %>% 
  subset(glmnet > 0.01) %>%
  subset(data_type == "full" & cell_type == "RBC") %>% 
  select(features_raw) %>%
  distinct %>%
  mutate(features_raw = feature_no[features_raw]) %>%
  unlist %>%
  sort %>%
  paste(collapse = ',') %>%
  writeLines(file_connection)
close(file_connection)
file.copy("data_output/rbc_feature_subset_unbiased",
          "../mile-vice/scripts/rbc_feature_subset_unbiased",
          overwrite = T)
```